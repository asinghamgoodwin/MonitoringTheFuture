---
title: "Community Attachment"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)
library(tidyverse)
require(haven)
require(stringr)
```

Using the paper [Associations between Community Attachments and Adolescent Substance Use in Nationally Representative Samples](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3699306/) as a reference, I'm trying to replicate the original results (1976-2008), and then see how community attachment relates to substance use in the period from 2009-2018.

Some random thoughts and new directions I have in mind for potential next steps:

* What's different about 2009-2018?
  * Legalization of marijuana
  * Opioid crisis
  * Financial crisis
  * Drug use in general going down, but marijuana staying constant
* Other exposures/predictors to look at:
  * Broader "society attachment" / faith in institutions (ex. do you think voting matters?)
  * Community/society engagement (not just attachment) - things like having a job, drivers license, community service
  * Deeper dive into gender differences?
* Another outcome: Mental health (internalizing/externalizing)?

# Code setup

## Step 0. Prepare helper functions, constants, etc.

Luckily, everything in the base set of community attachment measures, substance use, and most covariates are asked in form 1 (file 2). I'll also need to pull some basic demographics from the core form (file 1).

```{r general_constants}
all_years = 1976:2018
old_years = 1976:2008
new_years = 2009:2018
```


```{r create_mapping_import code=xfun::read_utf8('tools/mapping-variable-names-to-labels/create-mapping.R'), include=FALSE}
```

```{r get_specific_data_by_years_export code=xfun::read_utf8('tools/creating-datasets/get-specific-data-by-years.R'), include=FALSE}
```

Create a standardized list of names for variables across years.

*TODO - this shouldn't happen in this file.... once I've gotten a better handle on it I'd like to do this somewhere separate and have a definitive static file of standard names to reference.*

``` {r generate_mapping_files}

grade12_file1_mapping = tibble()
grade12_file2_mapping = tibble()

for (year in new_years) {
  grade12_file1_mapping = rbind(grade12_file1_mapping,
                                create_mapping(path = "~/Documents/Code/MTF/MTFData/12th_grade/",
                                               year = year,
                                               file_number = 1
                                               )
                                )
    grade12_file2_mapping = rbind(grade12_file2_mapping,
                                create_mapping(path = "~/Documents/Code/MTF/MTFData/12th_grade/",
                                               year = year,
                                               file_number = 2
                                               )
                                )
}
```


## Step 1: Creating a smaller database that includes only the variables I need

First, define the list of variables we want. These are from the original paper:
```{r base_variable_lists}
demographics = c(`R'S ID-SERIAL #`,
                 `SAMPLING WEIGHT`,
                 `R'S SEX`,
                 `R'S RACE`,
                 `R'S RACE B/W/H`,
                 `FATHR EDUC LEVEL`,
                 `MOTHR EDUC LEVEL`,
                 ``,
                 ``,
                 ``,
                 ``,
                 ``
                 )
                 # $$HIGHSCHOOLGRADES$?$,
                 # $$GRADUATIONLIKELIHOOD$2$,
                 # $$COLLEGEASPIRATIONS$?$
                 # )

social_trust = c(`PPL TRY BE FAIR`,
                 `PPL TRY B HLPFL`,
                 `PPL CAN B TRSTD`
                 )

social_responsibility = c(`IMP CNTRBTN SOC`,
                          `IMP LDR COMUNTY`,
                          `IMP CRRCT INEQL`
                          )

religiosity = c(`R'ATTND REL SVC`,
                `RLGN IMP R'S LF`)

community_attachment = c(social_trust,
                         social_responsibility,
                         religiosity
                         )

substance_use = c()
# Lifetime cigarette
# 30-day cigarette
# Lifetime alcohol
# 30-day alcohol
# Binge drinking (frequency of 5+ drinks)
# Any vs. no use of [lots of drugs]

```

These are new variables I'm potentially interested in:
```{r new_variable_lists}
# TODO - fill in later. Make sure the variables are from the same forms or can somehow be compared against what we're already searching for...
```

Get data from all participants for each of the variables above. Merge/combine by ID number.

*TODO: probably worth making/modifying a helper function so that the merges can be automatic. (figure out: how to code uncollected data?)*
```{r}
# TODO: add in from new_variable_lists once I get there

raw_data_file1 = get_specific_data_by_years(path = "~/Documents/Code/MTF/MTFData/12th_grade/",
                                     file_number = 1,
                                     years = all_years,
                                     mapping = grade12_file1_mapping,
                                     variables_to_include = c(demographics,
                                                              community_attachment,
                                                              substance_use)
                                     )

raw_data_file2 = get_specific_data_by_years(path = "~/Documents/Code/MTF/MTFData/12th_grade/",
                                     file_number = 2,
                                     years = all_years,
                                     mapping = grade12_file2_mapping,
                                     variables_to_include = c(demographics,
                                                              community_attachment,
                                                              substance_use)
                                     )
```

## Step 2: Recode, create indicators/aggregate values, etc.

At minimum:
1. Create social trust score
2. Create social responsibility score
3. Create religiosity score
4. Operationalize substance use (probably multiple different variables)
5. Combine momEd and dadEd into SES
6. Combine 2yr and 4yr college graduation expectations
7. Create dummy variable for each year of the survey, to account for historical trends. (Note: in original paper they did this and then found the dummy variables to not be significant. But it's worth it for me to check, both for 2009-2018 and if I add in any new predictors or outcoems.)

```{r data_wrangling}
# TODO: write code, look up from old MTF SAS file
```

# Random questions and notes for later:

* Is religiosity driving the whole community attachment indicator?
* Somewhere, data from before 1990 is formatted differently (names of columns), so I need to incorporate that into my code.